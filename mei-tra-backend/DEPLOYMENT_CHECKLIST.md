# æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã“ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ã€æœ¬ç•ªç’°å¢ƒã¸ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’å®‰å…¨ã«é©ç”¨ã™ã‚‹ãŸã‚ã®æ‰‹é †ã§ã™ã€‚

**âš ï¸ é‡è¦**: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆauth.users, user_profilesï¼‰ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã€å¿…ãšå…¨é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“‹ äº‹å‰ç¢ºèª

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ç·¨é›†æ¸ˆã¿
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨æˆåŠŸ
  ```bash
  cd mei-tra-backend
  supabase db reset
  ```
- [ ] å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé
  ```bash
  npm run test
  ```
- [ ] E2Eãƒ†ã‚¹ãƒˆé€šé
  ```bash
  npm run test:e2e
  ```
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ä½œç¢ºèª
  ```bash
  npm run start:dev
  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä»¥ä¸‹ã‚’ãƒ†ã‚¹ãƒˆ:
  # - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  # - ãƒ­ã‚°ã‚¤ãƒ³
  # - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
  # - ã‚²ãƒ¼ãƒ ä½œæˆãƒ»å‚åŠ 
  ```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å·®åˆ†ç¢ºèª

- [ ] æœ¬ç•ªç’°å¢ƒã¨ã®å·®åˆ†ã‚’ç¢ºèª
  ```bash
  supabase db diff --schema public --linked
  ```
- [ ] å·®åˆ†å†…å®¹ãŒæ„å›³ã—ãŸå¤‰æ›´ã®ã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã“ã¨ã‚’ç¢ºèª
  - âŒ DROP TABLE user_profiles
  - âŒ ALTER TABLE user_profiles DROP COLUMN
  - âœ… ALTER TABLE user_profiles ADD COLUMN (è¨±å®¹)
  - âœ… CREATE TABLE (æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ« - è¨±å®¹)

---

## ğŸ”’ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—

- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
  ```bash
  cd mei-tra-backend
  ./scripts/backup-production.sh
  ```
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
  ```bash
  ls -lh backups/
  # production_backup_YYYYMMDD_HHMMSS.sql ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  ```
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒæ­£å¸¸ï¼ˆ0ãƒã‚¤ãƒˆã§ãªã„ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
  - [ ] backups/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ä¿å­˜æ¸ˆã¿
  - [ ] å¿µã®ãŸã‚ã€åˆ¥ã®å ´æ‰€ã«ã‚‚ã‚³ãƒ”ãƒ¼ï¼ˆæ¨å¥¨ï¼‰

### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèª
  ```bash
  head -n 50 backups/production_backup_YYYYMMDD_HHMMSS.sql
  # COPY auth.users ã‚„ COPY user_profiles ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
  ```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤

### æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨

- [ ] æœ¬ç•ªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
  ```bash
  supabase projects list
  # mei-tra (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID) ã« â— ãƒãƒ¼ã‚¯ãŒã‚ã‚‹ã‹ç¢ºèª
  ```
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
  ```bash
  supabase db push --include-all --linked
  ```
- [ ] ã‚¨ãƒ©ãƒ¼ãªãå®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»ã‚’è¨˜éŒ²: `____å¹´__æœˆ__æ—¥ __:__`

---

## âœ… å‹•ä½œç¢ºèª

### æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

- [ ] æœ¬ç•ªã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- [ ] **æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½**ï¼ˆæœ€é‡è¦ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å: `___________`
  - ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ã¯ã„ / ã„ã„ãˆ
- [ ] **æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º**
  - è¡¨ç¤ºåãŒæ­£ã—ã„: ã¯ã„ / ã„ã„ãˆ
  - ã‚¢ãƒã‚¿ãƒ¼ãŒæ­£ã—ã„: ã¯ã„ / ã„ã„ãˆ
  - ã‚²ãƒ¼ãƒ çµ±è¨ˆãŒæ®‹ã£ã¦ã„ã‚‹: ã¯ã„ / ã„ã„ãˆ
- [ ] æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ†ã‚¹ãƒˆ
  - æ–°è¦ç™»éŒ²æˆåŠŸ: ã¯ã„ / ã„ã„ãˆ
  - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è‡ªå‹•ä½œæˆ: ã¯ã„ / ã„ã„ãˆ
- [ ] ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
  - ãƒ«ãƒ¼ãƒ ä½œæˆ: ã¯ã„ / ã„ã„ãˆ
  - ãƒ«ãƒ¼ãƒ å‚åŠ : ã¯ã„ / ã„ã„ãˆ
  - ã‚²ãƒ¼ãƒ é–‹å§‹: ã¯ã„ / ã„ã„ãˆ

### ãƒ­ã‚°ç¢ºèª

- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã«ã‚¨ãƒ©ãƒ¼ãªã—
  ```bash
  flyctl logs --app mei-tra-backend
  ```
- [ ] Supabase ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼ãªã—
  - Database â†’ Query Performance

---

## ğŸš¨ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå•é¡Œç™ºç”Ÿæ™‚ï¼‰

**å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ**

### Step 1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆç·Šæ€¥æ™‚ï¼‰

```bash
flyctl scale count 0 --app mei-tra-backend
```

### Step 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©å…ƒ

```bash
# æ–¹æ³•1: psql ã‚³ãƒãƒ³ãƒ‰ã§å¾©å…ƒ
# æœ¬ç•ªDB URLã¯ Supabase Dashboard > Settings > Database > Connection string ã‹ã‚‰å–å¾—
psql "postgresql://postgres.[PROJECT-REF]@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres" \
  < backups/production_backup_YYYYMMDD_HHMMSS.sql

# æ–¹æ³•2: Supabase Studio ã§å¾©å…ƒ
# 1. Supabase Dashboard ã‚’é–‹ã
# 2. SQL Editor ã«ç§»å‹•
# 3. backups/production_backup_YYYYMMDD_HHMMSS.sql ã®å†…å®¹ã‚’è²¼ã‚Šä»˜ã‘
# 4. å®Ÿè¡Œ
```

### Step 3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•

```bash
flyctl scale count 1 --app mei-tra-backend
```

### Step 4: å‹•ä½œç¢ºèª

- [ ] ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹

---

## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤è¨˜éŒ²

### ä»Šå›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±

- **ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: `____å¹´__æœˆ__æ—¥ __:__`
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«**: `_______________________________`
- **å¤‰æ›´å†…å®¹**: `_______________________________________`
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«**: `production_backup_YYYYMMDD_HHMMSS.sql`
- **ãƒ‡ãƒ—ãƒ­ã‚¤æ‹…å½“è€…**: `___________`
- **ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ**: æˆåŠŸ / å¤±æ•— / ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿæ–½

### å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ

- **å•é¡Œå†…å®¹**: `_______________________________________`
- **å¯¾å¿œå†…å®¹**: `_______________________________________`
- **è§£æ±ºæ™‚åˆ»**: `____å¹´__æœˆ__æ—¥ __:__`

---

## ğŸ“ ç·Šæ€¥é€£çµ¡å…ˆ

- **Supabase ã‚µãƒãƒ¼ãƒˆ**: https://supabase.com/dashboard/support
- **Fly.io ã‚µãƒãƒ¼ãƒˆ**: https://fly.io/dashboard

---

## ğŸ’¡ Tips

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

**å•é¡Œ**: `supabase db push` ã§ã‚¨ãƒ©ãƒ¼
```
Error: migration X failed
```
**å¯¾å‡¦**:
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã® SQL æ§‹æ–‡ã‚’ãƒã‚§ãƒƒã‚¯
3. ãƒ­ãƒ¼ã‚«ãƒ«ã§ `supabase db reset` ãŒæˆåŠŸã™ã‚‹ã‹ç¢ºèª

**å•é¡Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„
**å¯¾å‡¦**:
1. auth.users ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
2. user_profiles ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ

**å•é¡Œ**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„
**å¯¾å‡¦**:
1. user_profiles ã® RLS ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª
2. handle_new_user() ãƒˆãƒªã‚¬ãƒ¼ãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª

---

## âœ¨ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸå¾Œ

- [ ] ãƒãƒ¼ãƒ ã«å®Œäº†å ±å‘Š
- [ ] ã“ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- [ ] æ¬¡å›ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«æ”¹å–„ç‚¹ã‚’ãƒ¡ãƒ¢

**æ”¹å–„ç‚¹ãƒ¡ãƒ¢**:
```
_________________________________________________
_________________________________________________
_________________________________________________
```
