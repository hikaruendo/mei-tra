# ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 

æ˜å°‚ãƒˆãƒ©ãƒ³ãƒ—ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®æŠ€è¡“ä»•æ§˜ã¨ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆã‚’èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ—ï¸ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ã‚¿ãƒƒã‚¯æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ                            â”‚
â”‚  ãƒ–ãƒ©ã‚¦ã‚¶ (React/Next.js)                                     â”‚
â”‚  - Canvas API (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ç”»åƒæœ€é©åŒ–)                      â”‚
â”‚  - File API                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ FormData (multipart/form-data)
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Next.js API Route (BFF Pattern)                â”‚
â”‚  /api/user-profile/[id]/avatar                              â”‚
â”‚  - ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦æ©Ÿèƒ½                                 â”‚
â”‚  - Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è»¢é€                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ FormDataè»¢é€
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NestJS Backend                            â”‚
â”‚  UserProfileController                                       â”‚
â”‚  - Multer (ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†)                          â”‚
â”‚  - Sharp (ã‚µãƒ¼ãƒãƒ¼å´ç”»åƒæœ€é©åŒ–)                               â”‚
â”‚  - Supabase Storage SDK                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ Storage API
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Supabase Storage                           â”‚
â”‚  Bucket: avatars                                            â”‚
â”‚  - ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (S3äº’æ›)                            â”‚
â”‚  - RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼                         â”‚
â”‚  - Public URLç”Ÿæˆ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

### 1ï¸âƒ£ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´å‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mei-tra-frontend/lib/utils/imageOptimizer.ts`

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»åƒé¸æŠ (input type="file" or Drag & Drop)
   â†“
2. validateImageFile()
   - ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯: JPEG/PNG/WebP
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯: æœ€å¤§2MB
   â†“
3. optimizeImage() - Canvas APIã§æœ€é©åŒ–
   - 128x128ã«ãƒªã‚µã‚¤ã‚º (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒ)
   - WebPå½¢å¼ã«å¤‰æ›
   - å“è³ª: 80% (1å›ç›®)
   - ç›®æ¨™ã‚µã‚¤ã‚º: 50KBä»¥ä¸‹
   â†“
4. ã‚µã‚¤ã‚ºã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆã¯å†è©¦è¡Œ
   - å“è³ª: 60% (2å›ç›®)
   - ãã‚Œã§ã‚‚è¶…ãˆã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
   â†“
5. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º (Blob URL)
```

#### æœ€é©åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| é …ç›® | å€¤ |
|------|-----|
| å…¥åŠ›åˆ¶é™ | æœ€å¤§2MB |
| ãƒªã‚µã‚¤ã‚º | 128x128px (ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ä¿æŒ) |
| å‡ºåŠ›å½¢å¼ | WebP |
| å“è³ª (1å›ç›®) | 80% |
| å“è³ª (2å›ç›®) | 60% |
| ç›®æ¨™ã‚µã‚¤ã‚º | 50KBä»¥ä¸‹ |

#### ã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const validation = validateImageFile(file);
if (!validation.isValid) {
  throw new Error(validation.error);
}

// æœ€é©åŒ–
const optimized = await optimizeImage(file);
// â†’ { file: File, preview: string, originalSize: number, optimizedSize: number }
```

---

### 2ï¸âƒ£ Next.js API Route (BFF Pattern)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mei-tra-frontend/app/api/user-profile/[id]/avatar/route.ts`

#### å½¹å‰²

- **Backend for Frontend (BFF)** ãƒ‘ã‚¿ãƒ¼ãƒ³
- CORSå•é¡Œã®å›é¿
- èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªè»¢é€
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€

#### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
POST /api/user-profile/${userId}/avatar
  â†“
1. FormDataã‚’å—ã‘å–ã‚‹
2. Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª
   - Bearer ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è»¢é€:
   â†’ http://localhost:3333/api/user-profile/${userId}/avatar (é–‹ç™ºç’°å¢ƒ)
   â†’ ${NEXT_PUBLIC_BACKEND_URL}/api/user-profile/${userId}/avatar (æœ¬ç•ªç’°å¢ƒ)
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
```

---

### 3ï¸âƒ£ NestJS Backendå‡¦ç†

**ãƒ•ã‚¡ã‚¤ãƒ«**: `mei-tra-backend/src/controllers/user-profile.controller.ts`

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```typescript
@Post(':id/avatar')
@UseInterceptors(FileInterceptor('avatar'))
async uploadAvatar(@Param('id') id: string, @UploadedFile() file: Express.Multer.File)
```

#### å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—

```
1. MulterãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚‹
   - MaxFileSizeValidator: 2MB
   - FileTypeValidator: image/jpeg|jpg|png|webp
   â†“
2. Sharp ã§å†æœ€é©åŒ–
   - 128x128ã«ãƒªã‚µã‚¤ã‚º (fit: 'cover', position: 'center')
   - WebPå¤‰æ› (quality: 80, effort: 6)
   - æœ€å¤§50KBãƒã‚§ãƒƒã‚¯
   â†“
3. å¤ã„ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤
   - æ—¢å­˜ã®avatar_urlã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åæŠ½å‡º
   - Supabase Storageã‹ã‚‰å‰Šé™¤
   â†“
4. Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   - ãƒ•ã‚¡ã‚¤ãƒ«å: `avatar-${userId}-${timestamp}.webp`
   - ãƒã‚±ãƒƒãƒˆ: 'avatars'
   - contentType: 'image/webp'
   - cacheControl: '3600' (1æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
   â†“
5. Public URLã‚’å–å¾—
   - storage.from('avatars').getPublicUrl(fileName)
   â†“
6. user_profilesãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
   - UPDATE user_profiles SET avatar_url = ${publicUrl} WHERE id = ${userId}
```

#### Sharpæœ€é©åŒ–ã‚³ãƒ¼ãƒ‰

```typescript
private async optimizeImage(buffer: Buffer): Promise<Buffer> {
  return await sharp(buffer)
    .resize(128, 128, {
      fit: 'cover',
      position: 'center',
    })
    .webp({
      quality: 80,
      effort: 6,
    })
    .toBuffer();
}
```

---

### 4ï¸âƒ£ Supabase Storage

**ãƒã‚±ãƒƒãƒˆ**: `avatars`

#### ãƒã‚±ãƒƒãƒˆè¨­å®š

```sql
-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: 20260111100000_create_avatars_bucket.sql

INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'avatars',
  'avatars',
  true,                                                -- å…¬é–‹ãƒã‚±ãƒƒãƒˆ
  52428800,                                           -- 50MBåˆ¶é™
  ARRAY['image/jpeg', 'image/jpg', 'image/png', 'image/webp']
);
```

#### RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼

```sql
-- èª­ã¿å–ã‚Š: èª°ã§ã‚‚OK (å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹)
CREATE POLICY "Avatar images are publicly accessible" ON storage.objects
FOR SELECT USING (bucket_id = 'avatars');

-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ã¿
CREATE POLICY "Users can upload their own avatar" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'avatars'
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- æ›´æ–°: è‡ªåˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
CREATE POLICY "Users can update their own avatar" ON storage.objects
FOR UPDATE USING (
  bucket_id = 'avatars'
  AND auth.uid()::text = (storage.foldername(name))[1]
);

-- å‰Šé™¤: è‡ªåˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿
CREATE POLICY "Users can delete their own avatar" ON storage.objects
FOR DELETE USING (
  bucket_id = 'avatars'
  AND auth.uid()::text = (storage.foldername(name))[1]
);
```

#### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```
avatars/
â””â”€â”€ avatar-{userId}-{timestamp}.webp

ä¾‹:
avatars/avatar-e1b7ff9d-2ccc-49f3-bbab-003bc07d4924-1760768383743.webp
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ãƒ¦ãƒ¼ã‚¶ãƒ¼    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç”»åƒé¸æŠ (2MBä»¥ä¸‹)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æœ€é©åŒ–          â”‚
â”‚ Canvas API                   â”‚
â”‚ ãƒ»128x128ãƒªã‚µã‚¤ã‚º            â”‚
â”‚ ãƒ»WebPå¤‰æ› (quality: 80%)    â”‚
â”‚ ãƒ»ç›®æ¨™: 50KBä»¥ä¸‹             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ FormData POST
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route (BFF)      â”‚
â”‚ /api/user-profile/:id/avatar â”‚
â”‚ ãƒ»èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³è»¢é€           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ FormDataè»¢é€
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NestJS Backend               â”‚
â”‚ ãƒ»Multerã§ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡       â”‚
â”‚ ãƒ»Sharpå†æœ€é©åŒ–              â”‚
â”‚ ãƒ»å¤ã„ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Storage API
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Storage             â”‚
â”‚ avatars bucket               â”‚
â”‚ avatar-{id}-{ts}.webp        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Public URL
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL                   â”‚
â”‚ user_profiles.avatar_url     â”‚
â”‚ UPDATEå®Œäº†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰               â”‚
â”‚ ãƒ»AuthContextæ›´æ–°            â”‚
â”‚ ãƒ»ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼å†è¡¨ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æœ€é©åŒ–ãƒã‚¤ãƒ³ãƒˆ

### 1. äºŒé‡æœ€é©åŒ–æˆ¦ç•¥

#### ãªãœ2å›æœ€é©åŒ–ã™ã‚‹ã®ã‹ï¼Ÿ

| æœ€é©åŒ–ç®‡æ‰€ | æŠ€è¡“ | ç›®çš„ |
|-----------|------|------|
| **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´** | Canvas API | é€šä¿¡é‡å‰Šæ¸› (2MB â†’ 50KB) |
| **ã‚µãƒ¼ãƒãƒ¼å´** | Sharp | å“è³ªä¿è¨¼ãƒ»è¦æ ¼çµ±ä¸€ |

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… é€šä¿¡é‡95%å‰Šæ¸›
- âœ… ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é«˜é€ŸåŒ–)
- âœ… å“è³ªã®çµ±ä¸€æ€§ä¿è¨¼

---

### 2. ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

```
avatar-{userId}-{timestamp}.webp
```

**æ§‹æˆè¦ç´ **:
- `avatar-`: ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (è­˜åˆ¥ç”¨)
- `{userId}`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (UUID)
- `{timestamp}`: Unixã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— (ãƒŸãƒªç§’)
- `.webp`: æ‹¡å¼µå­

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ‰€æœ‰è€…è­˜åˆ¥
- âœ… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ä¸Šæ›¸ãé˜²æ­¢
- âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°åŠ¹æœ
- âœ… é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«åå›é¿

**ä¾‹**:
```
avatar-e1b7ff9d-2ccc-49f3-bbab-003bc07d4924-1760768383743.webp
```

---

### 3. å¤ã„ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤

```typescript
// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
const existingProfile = await this.userProfileRepository.findById(id);

if (existingProfile?.avatarUrl) {
  await this.deleteOldAvatar(existingProfile.avatarUrl);
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ç¯€ç´„
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ä¿æŒ
- âœ… ç„¡é§„ãªãƒ•ã‚¡ã‚¤ãƒ«è“„ç©é˜²æ­¢

---

### 4. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
// Supabase Storageã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚
{
  contentType: 'image/webp',
  cacheControl: '3600',  // 1æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  upsert: false
}
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ãƒ™ãƒ«**:
1. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 1æ™‚é–“
2. **CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 1æ™‚é–“ (Supabase CDN)
3. **Blob URL ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… å¸¯åŸŸå¹…å‰Šæ¸›
- âœ… è¡¨ç¤ºé€Ÿåº¦å‘ä¸Š
- âœ… ã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›

---

## ğŸ’° ã‚³ã‚¹ãƒˆæœ€é©åŒ–

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡

| é …ç›® | ã‚µã‚¤ã‚º |
|------|--------|
| 1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Š | 20-50KB (å¹³å‡30KB) |
| 1000ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ç´„30MB |
| 10000ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ç´„300MB |

### è»¢é€é‡å‰Šæ¸›

| ã‚·ãƒŠãƒªã‚ª | Before | After | å‰Šæ¸›ç‡ |
|---------|--------|-------|--------|
| 1å›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | 2MB | 50KB | **97.5%** |
| 1000å›/æœˆ | 2GB | 50MB | **97.5%** |

### Supabaseæ–™é‡‘ (å‚è€ƒ)

- **Free Tier**: 1GB Storage, 2GB Bandwidth
- **Pro Plan**: 8GB Storage, 50GB Bandwidth
- **ã“ã®ã‚·ã‚¹ãƒ†ãƒ **: 10,000ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚Free Tierã§é‹ç”¨å¯èƒ½ âœ…

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 1. èªè¨¼ãƒ»èªå¯

```typescript
// RLSãƒãƒªã‚·ãƒ¼ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDæ¤œè¨¼
auth.uid()::text = (storage.foldername(name))[1]
```

- âœ… Supabase JWTãƒˆãƒ¼ã‚¯ãƒ³ã§èªè¨¼
- âœ… è‡ªåˆ†ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æ“ä½œå¯èƒ½
- âœ… ä»–äººã®ã‚¢ãƒã‚¿ãƒ¼å‰Šé™¤ãƒ»ä¸Šæ›¸ãä¸å¯

---

### 2. ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´

```typescript
// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
if (!['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type)) {
  throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼');
}

if (file.size > 2 * 1024 * 1024) {
  throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™');
}
```

#### ã‚µãƒ¼ãƒãƒ¼å´

```typescript
// Multerãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
new MaxFileSizeValidator({ maxSize: 2 * 1024 * 1024 })
new FileTypeValidator({ fileType: /^image\/(jpeg|jpg|png|webp)$/ })

// Sharpå‡¦ç†å¾Œã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
if (optimizedBuffer.length > 50 * 1024) {
  throw new HttpException('Optimized image is still too large', 400);
}
```

---

### 3. XSSå¯¾ç­–

- âœ… WebPå½¢å¼ã®ã¿è¨±å¯ (ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŸ‹ã‚è¾¼ã¿ä¸å¯)
- âœ… Content-Typeæ¤œè¨¼
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­å¼·åˆ¶ (`.webp`)

---

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. ã‚¢ãƒã‚¿ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„

**åŸå› **:
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ2MBã‚’è¶…ãˆã¦ã„ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒå¯¾å¿œå¤– (GIF, BMPãªã©)

**å¯¾å‡¦**:
```typescript
// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
console.error(error.message);

// ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ç¢ºèª
console.log({
  name: file.name,
  type: file.type,
  size: file.size
});
```

---

#### 2. ã‚¢ãƒã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **:
- Public URLãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã¦ã„ãªã„
- RLSãƒãƒªã‚·ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹

**ç¢ºèªæ–¹æ³•**:
```sql
-- Supabase Dashboard > SQL Editor
SELECT id, avatar_url FROM user_profiles WHERE id = 'your-user-id';
```

**å¯¾å‡¦**:
```typescript
// AuthContext ã® refreshUserProfile() ã‚’å‘¼ã³å‡ºã™
await refreshUserProfile();
```

---

#### 3. å¤ã„ã‚¢ãƒã‚¿ãƒ¼ãŒæ®‹ã‚‹

**åŸå› **:
- deleteOldAvatar() ãŒå¤±æ•—ã—ã¦ã„ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ«åæŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯ã®å•é¡Œ

**ç¢ºèªæ–¹æ³•**:
```sql
-- Supabase Dashboard > Storage > avatars
-- åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
```

**å¯¾å‡¦**:
```typescript
// ãƒ­ã‚°ã‚’ç¢ºèª
this.logger.warn('Failed to delete old avatar:', error);
```

---

## ğŸ“š é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `mei-tra-frontend/lib/utils/imageOptimizer.ts` | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯ |
| `mei-tra-frontend/components/profile/ProfileEditForm.tsx` | ã‚¢ãƒã‚¿ãƒ¼ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  |
| `mei-tra-frontend/app/api/user-profile/[id]/avatar/route.ts` | Next.js API Route (BFF) |
| `mei-tra-frontend/contexts/AuthContext.tsx` | èªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° |

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `mei-tra-backend/src/controllers/user-profile.controller.ts` | ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰API |
| `mei-tra-backend/src/database/supabase.service.ts` | Supabaseæ¥ç¶šã‚µãƒ¼ãƒ“ã‚¹ |
| `mei-tra-backend/supabase/migrations/20260111100000_create_avatars_bucket.sql` | ãƒã‚±ãƒƒãƒˆä½œæˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |

---

## ğŸ”„ ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### 1. ç”»åƒå½¢å¼ã®æ‹¡å¼µ

- **AVIFå½¢å¼ã®ã‚µãƒãƒ¼ãƒˆ**: WebPã‚ˆã‚Šã•ã‚‰ã«é«˜åœ§ç¸®
- **ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³GIFã®ã‚µãƒãƒ¼ãƒˆ**: 1ãƒ•ãƒ¬ãƒ¼ãƒ ç›®ã‚’é™æ­¢ç”»ã«å¤‰æ›

### 2. é¡”èªè­˜ãƒ»è‡ªå‹•ã‚¯ãƒ­ãƒƒãƒ—

```typescript
// å°†æ¥çš„ãªå®Ÿè£…æ¡ˆ
import * as faceapi from 'face-api.js';

const detectFace = async (image: HTMLImageElement) => {
  const detection = await faceapi.detectSingleFace(image);
  if (detection) {
    // é¡”ã‚’ä¸­å¿ƒã«ã‚¯ãƒ­ãƒƒãƒ—
    return cropToFace(image, detection);
  }
};
```

### 3. CDNæœ€é©åŒ–

- **Cloudflare Images**: å‹•çš„ãƒªã‚µã‚¤ã‚ºãƒ»å¤‰æ›
- **è¤‡æ•°ã‚µã‚¤ã‚ºç”Ÿæˆ**: 32x32, 64x64, 128x128
- **WebP/AVIFè‡ªå‹•å¤‰æ›**: ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œã«å¿œã˜ã¦æœ€é©å½¢å¼

---

## ğŸ“– å‚è€ƒè³‡æ–™

- [Supabase Storage Documentation](https://supabase.com/docs/guides/storage)
- [Sharp Documentation](https://sharp.pixelplumbing.com/)
- [Canvas API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [WebP Image Format](https://developers.google.com/speed/webp)
